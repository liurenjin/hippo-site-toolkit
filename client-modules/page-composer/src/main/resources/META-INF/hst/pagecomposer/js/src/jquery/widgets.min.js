jQuery.noConflict();(function(a){a.namespace("Hippo.PageComposer.UI","Hippo.PageComposer.UI.Container","Hippo.PageComposer.UI.ContainerItem");Hippo.PageComposer.UI.Widget=Class.extend({init:function(c,b){this.id=c;this.overlayId=c+"-overlay";this.element=b;this.el=a(b);this.parent=null;this.noHover=true;this.sel={self:"#"+b.id,overlay:"#"+this.overlayId};this.cls={selected:"hst-selected",activated:"hst-activated",overlay:{base:"hst-overlay",hover:"hst-overlay-hover",mark:null,custom:null}};this.rendered=false},select:function(){a(this.element).addClass(this.cls.selected);a(this.overlay).addClass(this.cls.selected)},deselect:function(){a(this.element).removeClass(this.cls.selected);a(this.overlay).removeClass(this.cls.selected)},activate:function(){a(this.element).addClass(this.cls.activated)},deactivate:function(){a(this.element).addClass(this.cls.activated)},render:function(e){if(this.rendered){return}this.parent=e;var b=a.isFunction(e.getOverlay)?e.getOverlay():document.body;var d=a("<div/>").addClass(this.cls.overlay.base).appendTo(b);if(this.cls.overlay.mark!=null){d.addClass(this.cls.overlay.mark)}if(this.cls.overlay.custom!=null){d.addClass(this.cls.overlay.custom)}d.css("position","absolute");d.attr("hst:id",this.id);d.attr("id",this.overlayId);var c=this;d.hover(function(){c.onMouseOver(this)},function(){c.onMouseOut(this)});d.click(function(){c.onClick()});this.overlay=d;this._syncOverlay();this.onRender();this.rendered=true},updateSharedData:function(b){this.items.each(function(c,d){d.updateSharedData(b)})},toggleNoHover:function(){this.noHover=!this.noHover},sync:function(){this._syncOverlay()},destroy:function(){this.onDestroy();this.rendered=false},getOverlay:function(){return this.overlay},onClick:function(){},onMouseOver:function(b){if(!this.noHover){this.getOverlay().addClass(this.cls.overlay.hover)}},onMouseOut:function(b){if(!this.noHover){this.getOverlay().removeClass(this.cls.overlay.hover)}},onRender:function(){},onDestroy:function(){},_syncOverlay:function(){var e=this.getOverlaySource();var g=e.offset();var d=this.overlay;var c=d.css("border-left-width");var b=!!c?parseFloat(c.substring(0,c.length-2)):0;var f={left:g.left,top:g.top,width:e.outerWidth(),height:e.outerHeight(),position:"absolute",overlayBorder:b};f=this.getOverlayData(f);this.overlay.css("left",f.left).css("top",f.top).css("position",f.position).width(f.width).height(f.height);this._cachedOverlayData=f;this.onSyncOverlay()},getOverlayData:function(b){},getOverlaySource:function(){return a(this.element)},onSyncOverlay:function(){}});Hippo.PageComposer.UI.Container.Base=Hippo.PageComposer.UI.Widget.extend({init:function(d,c){this._super(d,c);this.items=new Hippo.Util.OrderedMap();this.ddTolerance="intersect";this.dropIndicator=null;this.direction=HST.DIR.VERTICAL;this.draw=new Hippo.Util.Draw({min:3,thresholdLow:0});this.parentMargin=0;this.cls.selected=this.cls.selected+"-container";this.cls.activated=this.cls.activated+"-container";this.cls.highlight="hst-highlight";this.cls.overlay.custom="hst-overlay-container";this.cls.container="hst-container";this.cls.item="hst-container-item";this.cls.emptyContainer="hst-empty-container";this.cls.emptyItem="hst-empty-container-item";this.cls.overlay.item="hst-overlay-container-item";this.sel.container=this.sel.self+" ."+this.cls.container;this.sel.item=this.sel.self+" div.componentContentWrapper";this.sel.itemWrapper=this.sel.self+" ."+this.cls.item;this.sel.sortable=this.sel.overlay;this.sel.sort={items:this.sel.sortable+" ."+this.cls.overlay.item,itemsRel:"."+this.cls.overlay.item};this.sel.append={item:"",container:"",insertAt:""};this.isEmpty=a(this.sel.item).size()>0;var b=this;a(this.sel.item).each(function(){b._insertNewItem(this,true)});this.state=new Hippo.PageComposer.UI.DDState(this.items.keySet())},onRender:function(){this._super();this._renderItems();this._createSortable();this._checkEmpty();this.sync()},onDestroy:function(){this._destroySortable()},_renderItems:function(){this.eachItem(function(b,c){this._renderItem(c)})},_renderItem:function(b){b.render(this)},_insertNewItem:function(d,f,b){var e=Hippo.PageComposer.UI.Factory.createOrRetrieve(d);this.items.put(e.id,e,b);if(!f){var c=this.createItemElement(e.element);this.appendItem(c,b)}return e},_syncAll:function(){this.parent.checkStateChanges()},_checkEmpty:function(){if(this.items.size()==0){if(!this.el.hasClass(this.cls.emptyContainer)){this.el.addClass(this.cls.emptyContainer);this.overlay.addClass(this.cls.emptyContainer);var b=this.cls.item;this.cls.item=this.cls.emptyItem;var c=this.createItemElement(a('<div class="empty-container-placeholder">Drop Component Here</div>')[0]);this.appendItem(c);this.cls.item=b}}else{if(this.el.hasClass(this.cls.emptyContainer)){this.el.removeClass(this.cls.emptyContainer);this.overlay.removeClass(this.cls.emptyContainer);a(this.sel.container+" ."+this.cls.emptyItem).remove()}}},_syncItems:function(b){this.eachItem(function(c,d){if(typeof d!=="undefined"){d.sync()}else{if(!b&&Hippo.PageComposer.Main.isDebug()){console.warn("ContainerItem with id="+id+" is not found in active map.")}}})},_createSortable:function(){a(this.sel.sortable).sortable({items:this.sel.sort.itemsRel,connectWith:"."+this.cls.overlay.base,start:a.proxy(this.ddOnStart,this),stop:a.proxy(this.ddOnStop,this),helper:a.proxy(this.ddHelper,this),update:a.proxy(this.ddOnUpdate,this),receive:a.proxy(this.ddOnReceive,this),remove:a.proxy(this.ddOnRemove,this),tolerance:this.ddTolerance,change:a.proxy(this.ddOnChange,this)}).disableSelection()},_destroySortable:function(){a(this.sel.sortable).sortable("destroy")},beforeDrag:function(){this.toggleNoHover()},afterDrag:function(){this.toggleNoHover();this.draw.reset()},ddOnStart:function(c,d){var e=a(d.item).attr(HST.ATTR.ID);var b=this.items.get(e);this.parent.onDragStart(d,this);b.onDragStart(c,d)},ddOnStop:function(c,d){var e=a(d.item).attr(HST.ATTR.ID);if(this.items.containsKey(e)){var b=this.items.get(e);b.onDragStop(c,d)}this.parent.onDragStop(d);this._syncAll()},ddOnUpdate:function(b,c){this.state.syncItemsWithOverlayOrder=true},ddOnReceive:function(d,e){var f=e.item.attr(HST.ATTR.ID);var c=Hippo.PageComposer.UI.Factory.getById(f);var b=this;a(this.sel.sort.items).each(function(g){var h=a(this).attr(HST.ATTR.ID);if(h==f){c.onDragStop(d,e);c.destroy();b.add(c.element,g);b.state.syncOverlaysWithItemOrder=true;return false}})},ddOnRemove:function(b,c){var d=a(c.item).attr(HST.ATTR.ID);this.removeItem(d,true)},ddHelper:function(d,b){var e=b.attr(HST.ATTR.ID);var c=this.items.get(e);return c.menu.clone().css("width","100px").css("height","18px").offset({top:d.clientY,left:d.clientX}).appendTo(document.body)},ddOnChange:function(b,c){this.parent.onDrag(c,this)},drawDropIndicator:function(g,e){if(g.placeholder.siblings().length==0){this.draw.inside(this.el,e,this.direction)}else{var f=g.placeholder.prev();var d=g.placeholder.next();var b=function(h){return Hippo.PageComposer.UI.Factory.getById(h.attr(HST.ATTR.ID)).el};var c=g.item[0];if(f[0]==c||(d.length>0&&d[0]==c)){this.draw.inside(b(g.item),e,this.direction)}else{if(f.length==0){this.draw.before(b(d),e,this.direction)}else{if(d.length==0){this.draw.after(b(f),e,this.direction)}else{this.draw.between(b(f),b(d),e,this.direction)}}}}},getOverlayData:function(c){if(c.overlayBorder>0){var b=c.overlayBorder*2;c.left-=b;c.top-=b;c.width+=b;c.height+=b;this.parentMargin=c.overlayBorder}return c},highlight:function(){this.overlay.addClass(this.cls.highlight)},unhighlight:function(){this.overlay.removeClass(this.cls.highlight)},checkState:function(){if(this.state.checkEmpty){this._checkEmpty()}if(this.state.syncOverlaysWithItemOrder){var f=this.items.getIndexMap();var e=a(this.sel.sort.items).get();e.sort(function(i,h){i=f[a(i).attr(HST.ATTR.ID)];h=f[a(h).attr(HST.ATTR.ID)];return(i<h)?-1:(i>h)?1:0});var d=this;a.each(e,function(h,i){d.overlay.append(i)})}else{if(this.state.syncItemsWithOverlayOrder){var b=[];a(this.sel.sort.items).each(function(){var h=a(this).attr(HST.ATTR.ID);b.push(h)});this.items.updateOrder(b);var f=this.items.getIndexMap();var c=a(this.sel.container);var e=a(this.sel.itemWrapper).get();e.sort(function(i,h){i=f[a("div.componentContentWrapper",i).attr(HST.ATTR.ID)];h=f[a("div.componentContentWrapper",h).attr(HST.ATTR.ID)];return(i<h)?-1:(i>h)?1:0});a.each(e,function(h,i){c.append(i)})}}var g=this.items.keySet();if(this.state.orderChanged(g)){this.state.previousOrder=g;this.parent.requestSync();sendMessage({id:this.id,children:g},"rearrange")}this.state.reset()},toggleNoHover:function(){this._super();this.eachItem(function(b,c){c.toggleNoHover()})},sync:function(){this._syncOverlay();this._syncItems(true)},add:function(c,b){var d=this._insertNewItem(c,false,b);this._renderItem(d);a(this.sel.sortable).sortable("refresh");this.state.checkEmpty=true},remove:function(b){},removeItem:function(d,b){if(this.items.containsKey(d)){var c=this.items.remove(d);a(c.element).parents("."+this.cls.item).remove();if(!b){c.destroy()}this.state.checkEmpty=true;return true}return false},hasItem:function(b){return this.items.containsKey(b)},eachItem:function(c,b){this.items.each(c,b||this)},appendItem:function(c,b){if(a(this.sel.append.item).size()==0){a(this.sel.append.container).append(c)}else{if(b>-1){if(b==0){c.insertBefore(this.sel.append.insertAt+":eq(0)")}else{c.insertAfter(this.sel.append.insertAt+":eq("+(b-1)+")")}}else{c.insertAfter(this.sel.append.insertAt+":last")}}},createItemElement:function(b){}});Hippo.PageComposer.UI.Factory.register("HST.BaseContainer",Hippo.PageComposer.UI.Container.Base);Hippo.PageComposer.UI.Container.Table=Hippo.PageComposer.UI.Container.Base.extend({init:function(c,b){this._super(c,b);this.sel.append.item=this.sel.container+" > tbody > tr."+this.cls.item;this.sel.append.container=this.sel.container+" > tbody";this.sel.append.insertAt=this.sel.container+" > tbody > tr"},createItemElement:function(b){var c=a("<td></td>").append(b);return a('<tr class="'+this.cls.item+'"></tr>').append(c)}});Hippo.PageComposer.UI.Factory.register("HST.Table",Hippo.PageComposer.UI.Container.Table);Hippo.PageComposer.UI.Container.UnorderedList=Hippo.PageComposer.UI.Container.Base.extend({init:function(c,b){this._super(c,b);this.sel.append.item=this.sel.container+" > li."+this.cls.item;this.sel.append.container=this.sel.container;this.sel.append.insertAt=this.sel.container+" > li"},createItemElement:function(b){return a('<li class="'+this.cls.item+'"></li>').append(b)}});Hippo.PageComposer.UI.Factory.register("HST.UnorderedList",Hippo.PageComposer.UI.Container.UnorderedList);Hippo.PageComposer.UI.Container.OrderedList=Hippo.PageComposer.UI.Container.Base.extend({init:function(c,b){this._super(c,b);this.sel.append.item=this.sel.container+" > li."+this.cls.item;this.sel.append.container=this.sel.container;this.sel.append.insertAt=this.sel.container+" > li"},createItemElement:function(b){return a('<li class="'+this.cls.item+'"></li>').append(b)}});Hippo.PageComposer.UI.Factory.register("HST.OrderedList",Hippo.PageComposer.UI.Container.OrderedList);Hippo.PageComposer.UI.Container.VerticalBox=Hippo.PageComposer.UI.Container.Base.extend({init:function(c,b){this._super(c,b);this.sel.append.item=this.sel.container+" > div."+this.cls.item;this.sel.append.container=this.sel.container;this.sel.append.insertAt=this.sel.container+" > div"},createItemElement:function(b){return a('<div class="'+this.cls.item+'"></div>').append(b)}});Hippo.PageComposer.UI.Factory.register("HST.vBox",Hippo.PageComposer.UI.Container.VerticalBox);Hippo.PageComposer.UI.ContainerItem.Base=Hippo.PageComposer.UI.Widget.extend({init:function(e,c){this._super(e,c);this.cls.selected=this.cls.selected+"-containerItem";this.cls.activated=this.cls.activated+"-containerItem";this.cls.overlay.mark="hst-overlay-container-item";var d=a(c);var b=d.attr("hst:temporary");this.isTemporary=typeof b!=="undefined";if(this.isTemporary){d.html("Click to refresh")}this.data={name:"loading.."}},onRender:function(){this.menu=a("<div/>").addClass("hst-overlay-menu");var c={element:this.element};var d=a("<div/>").addClass("hst-overlay-menu-button").html("X");d.click(function(f){f.stopPropagation();sendMessage(c,"remove")});this.menu.append(d);var b=a("<div/>").addClass("hst-overlay-name-label");this.menu.append(b);this.nameLabel=b;this.renderLabelContents();this.overlay.append(this.menu)},sync:function(){this._super();this.menu.position({my:"right top",at:"right top",of:this.overlay,offset:"-2 2"})},getOverlayData:function(c){c.position="inherit";var b=this.parent.overlay.offset();c.left-=(b.left+this.parent.parentMargin);c.top-=(b.top+this.parent.parentMargin);c.width-=c.overlayBorder*2;c.height-=c.overlayBorder*2;return c},updateSharedData:function(b){this.data.name=b.getName(this.id);this.renderLabelContents()},renderLabelContents:function(){this.nameLabel.html(this.data.name)},getOverlaySource:function(){return a(this.element)},onClick:function(){if(this.isTemporary){sendMessage({},"refresh")}else{sendMessage({element:this.element},"onclick")}},onDragStart:function(b,c){a(this.element).addClass("hst-item-ondrag");this.menu.hide()},onDragStop:function(b,c){a(this.element).removeClass("hst-item-ondrag");this.menu.show()},onDestroy:function(){this.overlay.remove();this.menu.remove()}});Hippo.PageComposer.UI.Factory.register("HST.Item",Hippo.PageComposer.UI.ContainerItem.Base);Hippo.PageComposer.UI.DDState=function(b){this.checkEmpty=false;this.syncItemsWithOverlayOrder=false;this.syncOverlaysWithItemOrder=false;this.previousOrder=b};Hippo.PageComposer.UI.DDState.prototype={orderChanged:function(c){if(c.length!=this.previousOrder.length){return true}for(var b=0;b<c.length;b++){if(c[b]!=this.previousOrder[b]){return true}}return false},reset:function(){this.checkEmpty=false;this.syncItemsWithOverlayOrder=false;this.syncOverlaysWithItemOrder=false}}})(jQuery);